<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEP - Sustainable Startups Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- DaisyUI + Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.3/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-in-right': 'slideInRight 0.8s cubic-bezier(0.4, 0, 0.2, 1)',
                        'fade-in-down': 'fadeInDown 0.8s ease-out',
                        'spin-slow': 'spin 1s linear infinite',
                        'fade-scale': 'fadeInScale 0.3s ease'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px) rotate(0deg)', opacity: '0.7' },
                            '50%': { transform: 'translateY(-20px) rotate(180deg)', opacity: '1' }
                        },
                        slideInRight: {
                            'from': { transform: 'translateX(100%)', opacity: '0' },
                            'to': { transform: 'translateX(0)', opacity: '1' }
                        },
                        fadeInDown: {
                            'from': { transform: 'translateY(-30px)', opacity: '0' },
                            'to': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeInScale: {
                            'from': { opacity: '0', transform: 'scale(0.9)' },
                            'to': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Fix Leaflet popup z-index and positioning issues */
        .leaflet-popup-pane {
            z-index: 700 !important;
        }
        
        .leaflet-popup {
            z-index: 700 !important;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #d1fae5;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 0;
            max-height: 180px;
            overflow-y: auto;
        }
        
        .custom-popup .leaflet-popup-tip {
            background: white;
            border: 1px solid #d1fae5;
        }
        
        /* Ensure popup appears above sidebar */
        .leaflet-control-container {
            z-index: 700 !important;
        }
        
        /* Make sure map container has proper stacking */
        #map {
            z-index: 1;
        }
        
        /* Ensure popup content is scrollable if needed */
        .custom-popup .leaflet-popup-content-wrapper {
            max-height: 250px;
        }
        
        .custom-popup .leaflet-popup-content {
            max-height: 230px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="font-inter min-h-screen text-gray-700 overflow-x-hidden bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50">
    
    <!-- Floating Particles -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute w-1 h-1 bg-green-300 bg-opacity-50 rounded-full animate-float" style="left: 10%; top: 20%; animation-delay: 0s;"></div>
        <div class="absolute w-1.5 h-1.5 bg-emerald-300 bg-opacity-50 rounded-full animate-float" style="left: 20%; top: 80%; animation-delay: 2s;"></div>
        <div class="absolute w-1 h-1 bg-teal-300 bg-opacity-50 rounded-full animate-float" style="left: 75%; top: 30%; animation-delay: 4s;"></div>
        <div class="absolute w-1.5 h-1.5 bg-green-400 bg-opacity-50 rounded-full animate-float" style="left: 85%; top: 70%; animation-delay: 1s;"></div>
        <div class="absolute w-1 h-1 bg-emerald-400 bg-opacity-50 rounded-full animate-float" style="left: 15%; top: 50%; animation-delay: 3s;"></div>
        <div class="absolute w-1.5 h-1.5 bg-teal-400 bg-opacity-50 rounded-full animate-float" style="left: 60%; top: 10%; animation-delay: 5s;"></div>
    </div>

    <!-- Portfolio-Style Navbar -->
    <header id="header" class="navbar fixed top-0 left-0 w-full z-50 transition-all duration-300 ease-in-out bg-white shadow-sm">
        <div class="navbar-start">
            <div class="dropdown">
                <div tabIndex="0" role="button" class="btn btn-ghost lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </div>
                <ul tabIndex="0" class="menu menu-sm dropdown-content bg-white rounded-box z-[1] mt-3 w-52 p-2 shadow">
                    <li><a href="index.html" class="text-green-600 font-semibold">Home</a></li>
                    <li><a href="add-startup.html">Add Startup</a></li>
                </ul>
                <a href="index.html" class="hidden lg:flex btn btn-ghost text-xl text-green-700 hover:text-green-900">üå± EcoMap</a>
            </div>
        </div>
        
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a href="index.html" class="text-green-600 font-semibold">Home</a></li>
                <li><a href="add-startup.html">Add Startup</a></li>
            </ul>
        </div>
        
        <div class="navbar-end">
            <div id="logout-section" class="hidden mr-4">
                <button onclick="logout()" class="btn btn-sm btn-outline btn-error">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            <a href="index.html" class="btn md:hidden btn-ghost text-xl text-green-700 hover:text-green-900">üå± EcoMap</a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="grid grid-cols-1 lg:grid-cols-2 h-screen pt-16">
        <!-- Map Container -->
        <div class="relative bg-gray-100 h-full lg:h-screen">
            <div id="map" class="w-full h-full"></div>
        </div>
        
        <!-- Sidebar Container -->
        <div class="relative h-full lg:h-screen">
            <!-- Mobile Overlay -->
            <div class="overlay fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>
            
            <!-- Mobile Hamburger -->
            <button class="hamburger-btn fixed top-20 right-4 z-50 lg:hidden btn btn-circle bg-green-600 hover:bg-green-700 text-white shadow-lg" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Sidebar -->
            <div class="sidebar fixed lg:relative top-0 right-0 lg:right-auto w-full sm:w-96 lg:w-full h-full bg-white backdrop-blur-md border-l border-green-200 overflow-y-auto p-6 lg:p-10 z-40 transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out animate-slide-in-right shadow-xl lg:shadow-none">
                <!-- Close Button -->
                <button class="close-btn absolute top-4 right-4 lg:hidden btn btn-sm btn-circle btn-ghost text-red-500 hover:text-red-700" onclick="toggleSidebar()">
                    <i class="fas fa-times text-lg"></i>
                </button>
                
                <!-- Header -->
                <div class="text-center mb-8 animate-fade-in-down">
                    <h1 class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent mb-2">üå± Sustainable Startups</h1>
                    <p class="text-gray-600 text-lg">Discover eco-innovation across Southeast Asia</p>
                </div>

                <!-- Search Filter -->
                <div class="mb-8">
                    <input type="text" 
                           id="searchInput" 
                           placeholder="Search by company name..." 
                           class="input input-bordered w-full bg-white bg-opacity-70 backdrop-blur-sm border-green-300 focus:border-green-500 focus:ring focus:ring-green-200 text-gray-800 placeholder-gray-500"
                           oninput="filterCompaniesByName()">
                    <div id="search-results-info" class="mt-2 text-sm text-gray-600 hidden"></div>
                </div>

                <!-- API Startups Section -->
                <div id="api-startups-card" class="mb-8">
                    <h3 class="text-2xl font-semibold text-green-700 mb-6">API Startups</h3>
                    <div id="api-startup-list" class="space-y-6">
                        <!-- Loading State -->
                        <div class="flex flex-col items-center justify-center py-16 text-green-600">
                            <div class="loading loading-spinner loading-lg text-green-600"></div>
                            <p class="mt-4 font-medium animate-pulse">Loading data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <script>
        let map;
        let markers = [];
        let filteredStartups = [];
        let allStartups = [];
        let isLoggedIn = false;

        async function fetchStartupData() {
            try {
                console.log('üöÄ Fetching data from Google Apps Script...');
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbwqvhfwWDLe6_9B5LBlQSEdt4R53bSf9L5x3cEtxB_UWtXNvQ5tJRcP0XoFjDTmlwFJYA/exec');
                
                if (response.redirected) {
                    console.log('‚ö†Ô∏è API redirected to:', response.url);
                }
                
                const data = await response.json();
                return Array.isArray(data) ? data : [data];
                
            } catch (error) {
                console.error('%c‚ùå FAILED TO FETCH GOOGLE SHEETS DATA:', 'color: #ff0000; font-size: 14px;');
                console.error('Error:', error);
                return [];
            }
        }

        async function loadStartups() {
            try {
                const startupData = await fetchStartupData();
                console.log('üìä Total Google Sheets companies loaded:', startupData.length);
                
                displayAPIDataInSidebar(startupData);
                
                if (startupData.length > 0) {
                    console.log('‚úÖ Google Sheets data loaded successfully!');
                    
                    const processedCompanies = await processCompaniesWithAddress(startupData);
                    allStartups = processedCompanies;
                    filteredStartups = [...allStartups];
                    
                    addMarkers();
                    console.log('‚ú® UI updated with Google Sheets address data!');
                } else {
                    console.log('‚ö†Ô∏è Google Sheets empty, using sample data...');
                    allStartups = getFullStartupData();
                    filteredStartups = [...allStartups];
                    addMarkers();
                }
                
            } catch (error) {
                console.error('‚ùå Google Sheets load error:', error);
                console.log('üîÑ Using fallback sample data...');
                allStartups = getFullStartupData();
                filteredStartups = [...allStartups];
                addMarkers();
            }
        }

        async function processCompaniesWithAddress(companies) {
            console.log('üìç Geocoding addresses for companies...');
            
            const processedCompanies = [];
            let geocodedCount = 0;
            
            const testLocations = {
                0: { lat: 3.1390, lng: 101.6869 }, // Kuala Lumpur
                1: { lat: 1.3521, lng: 103.8198 }, // Singapore  
                2: { lat: 13.7563, lng: 100.5018 }, // Bangkok
                3: { lat: -6.2088, lng: 106.8456 }, // Jakarta
                4: { lat: 14.5995, lng: 120.9842 }, // Manila
                5: { lat: 16.8713, lng: 96.1994 }, // Yangon
                6: { lat: 11.5449, lng: 104.9214 }, // Phnom Penh
                7: { lat: 17.9757, lng: 102.6331 }, // Vientiane
                8: { lat: 21.0278, lng: 105.8342 }, // Hanoi
                9: { lat: 22.3193, lng: 114.1694 }, // Hong Kong
            };
            
            for (let i = 0; i < companies.length; i++) {
                const company = companies[i];
                const processedCompany = { ...company };
                
                processedCompany.lat = testLocations[i % 10].lat;
                processedCompany.lng = testLocations[i % 10].lng;
                processedCompany.name = company['Company Name'];
                processedCompany.country = 'Southeast Asia';
                processedCompany.category = company['Industry / Products & Services'] || 'Unknown';
                processedCompany.description = company['Job Description']?.substring(0, 200) + '...' || 'Sustainable startup';
                processedCompany.internshipInfo = company['Possible internship roles'] || 'Various internships available';
                processedCompany.image = 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=150&h=150&fit=crop';
                
                processedCompanies.push(processedCompany);
                geocodedCount++;
            }
            
            console.log(`üìä Assigned coordinates for ${geocodedCount}/${companies.length} companies`);
            return processedCompanies;
        }

        function displayAPIDataInSidebar(data) {
            const container = document.getElementById('api-startup-list');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="card bg-base-100 shadow-xl p-6"><p class="text-center text-gray-500">No API data available</p></div>';
                return;
            }

            container.innerHTML = '';
            companyData = [...data];
                
            data.forEach((item, index) => {
                const {
                    ['Company Name']: companyName = 'N/A',
                    Status = 'N/A',
                    Address = '',
                    ['Contact Person']: contactPerson = '',
                    ['Contact Number']: contactNumber = '',
                    Email = '',
                    Website = '',
                    ['Job Description']: jobDescription = '',
                    ['Company Contact number']: companyContact = '',
                    LinkedIn = '',
                    Facebook = '',
                    Instagram = '',
                    ['Industry / Products & Services']: industry = '',
                    ['Possible internship roles']: roles = '',
                    ['OEP Batch']: oepBatch = ''
                } = item;

                const card = document.createElement('div');
                card.className = 'card bg-white bg-opacity-80 backdrop-blur-sm shadow-xl hover:shadow-2xl transition-all duration-300 transform border hover:border-green-200 hover:border-green-400';
                card.innerHTML = `
                    <div class="card-body p-6">
                        <h3 class="card-title text-2xl font-bold text-gray-800 mb-4">${companyName}</h3>
                        
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <span class="font-semibold text-gray-700 w-24">Status:</span>
                                <span class="badge badge-outline badge-success">${Status}</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-semibold text-gray-700 w-24 mt-1">Address:</span>
                                <span class="text-gray-600 flex-1">${Address.replace(/\n/g, '<br>')}</span>
                            </div>
                            
                            <div class="flex items-start">
                                <span class="font-semibold text-gray-700 w-24 mt-1">Roles:</span>
                                <span class="text-gray-600 flex-1">${roles}</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <p class="font-semibold text-gray-700 mb-2">Job Description:</p>
                            <div id="truncated-desc-${index}" class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600 leading-relaxed">
                                ${jobDescription.length > 120 ? jobDescription.substring(0, 120) + '...' : jobDescription}
                            </div>
                            <button onclick="handleDetailsButton(${index})" class="btn btn-sm bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white border-0 mt-4" id="details-btn-${index}">
                                ${isLoggedIn ? 'See full details...' : 'Login to view details'}
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function updateButtonsAfterLogin() {
            // Update all existing buttons to show "See full details" after login
            const buttons = document.querySelectorAll('[id^="details-btn-"]');
            buttons.forEach(button => {
                button.textContent = 'See full details...';
            });
            
            // Show logout button
            const logoutSection = document.getElementById('logout-section');
            if (logoutSection) {
                logoutSection.classList.remove('hidden');
            }
        }

        function logout() {
            isLoggedIn = false;
            
            // Update all buttons back to "Login to view details"
            const buttons = document.querySelectorAll('[id^="details-btn-"]');
            buttons.forEach(button => {
                button.textContent = 'Login to view details';
            });
            
            // Hide logout button
            const logoutSection = document.getElementById('logout-section');
            if (logoutSection) {
                logoutSection.classList.add('hidden');
            }
            
            showToast('Successfully logged out', 'success');
        }

        let companyData = [];

        function handleDetailsButton(index) {
            if (!companyData[index]) return;
            
            if (isLoggedIn) {
                showActualDetails(index);
            } else {
                showLoginModal(index);
            }
        }

        function showFullCardDetails(index) {
            if (!companyData[index]) return;
            
            if (isLoggedIn) {
                showActualDetails(index);
            } else {
                showLoginModal(index);
            }
        }

        function showLoginModal(index) {
            const loginModal = document.createElement('div');
            loginModal.id = 'loginModal';
            loginModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] backdrop-blur-sm p-5';
            
            const loginContent = document.createElement('div');
            loginContent.className = 'bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all';
            
            loginContent.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-lock text-green-600 text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Login Required</h2>
                    <p class="text-gray-600 mb-6">Please login to view full company details</p>
                    
                    <div class="mb-4">
                        <input type="password" 
                               id="loginInput" 
                               placeholder="Enter password"
                               class="input input-bordered w-full bg-gray-50 border-gray-300 focus:border-green-500 focus:ring focus:ring-green-200"
                               onkeypress="if(event.key === 'Enter') performLogin(${index})">
                    </div>
                    
                    <div class="flex gap-3 justify-center">
                        <button onclick="performLogin(${index})" class="btn bg-green-600 hover:bg-green-700 text-white border-0">
                            Login
                        </button>
                        <button onclick="closeLoginModal()" class="btn btn-ghost">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            loginModal.appendChild(loginContent);
            document.body.appendChild(loginModal);
            
            document.getElementById('loginInput').focus();
            
            loginModal.addEventListener('click', function(e) {
                if (e.target === loginModal) {
                    closeLoginModal();
                }
            });
        }

        function showPasswordModal(index) {
            showLoginModal(index);
        }

        function performLogin(index) {
            const password = document.getElementById('loginInput').value;
            if (password === 'oep') {
                isLoggedIn = true;
                closeLoginModal();
                updateButtonsAfterLogin();
                showActualDetails(index);
                showToast('Successfully logged in!', 'success');
            } else {
                showToast('Invalid password', 'error');
                document.getElementById('loginInput').value = '';
                document.getElementById('loginInput').focus();
            }
        }

        function checkPassword(index) {
            performLogin(index);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 z-[70] px-4 py-2 rounded-lg shadow-lg text-white font-medium animate-fade-scale`;
            toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#10b981';
            
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'scale(0.9)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function closePasswordModal() {
            closeLoginModal();
        }

        function showActualDetails(index) {
            const company = companyData[index];
            
            const modal = document.createElement('div');
            modal.id = 'fullCardModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm p-5';

            const content = document.createElement('div');
            content.className = 'bg-white rounded-2xl p-8 max-w-2xl max-h-[80vh] overflow-y-auto shadow-2xl relative transform transition-all';
            
            content.innerHTML = `
                <button onclick="closeFullCardModal()" class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost text-gray-400 hover:text-gray-600">
                    <span class="text-xl">&times;</span>
                </button>
                
                <div class="space-y-6 text-gray-700">
                    <h2 class="text-3xl font-bold text-green-700 mr-8">${company['Company Name']}</h2>
                    
                    <div class="grid gap-4">
                        <div class="flex items-center">
                            <strong class="text-white-900 w-32">Status:</strong> 
                            <span class="badge badge-success text-white">${company['Status']}</span>
                        </div>
                        
                        <div>
                            <strong class="text-gray-900">Address:</strong>
                            <div class="bg-gray-50 p-4 rounded-lg mt-2 border-l-4 border-green-500">
                                ${company['Address'] ? company['Address'].replace(/\n/g, '<br>') : 'Not provided'}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <strong class="text-gray-900">Contact Person:</strong><br>
                                <span class="text-gray-600">${company['Contact Person'] || 'Not specified'}</span>
                            </div>
                            
                            <div>
                                <strong class="text-gray-900">Phone:</strong><br>
                                <span class="text-gray-600">${company['Contact Number'] || company['Company Contact number'] || 'Not provided'}</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <strong class="text-gray-900">Email:</strong><br>
                                ${company['Email'] ? `<a href="mailto:${company['Email']}" class="link link-primary">${company['Email']}</a>` : 'Not provided'}
                            </div>
                            
                            <div>
                                <strong class="text-gray-900">Website:</strong><br>
                                ${company['Website'] ? `<a href="${company['Website']}" target="_blank" class="link link-primary">${company['Website']}</a>` : 'Not provided'}
                            </div>
                        </div>
                        
                        <div>
                            <strong class="text-gray-900">Industry / Products & Services:</strong>
                            <div class="bg-gray-50 p-4 rounded-lg mt-2 border-l-4 border-green-500">
                                ${company['Industry / Products & Services']?.replace(/\n/g, '<br>') || 'Not specified'}
                            </div>
                        </div>
                        
                        <div>
                            <strong class="text-gray-900">Possible Internship Roles:</strong>
                            <div class="bg-gray-50 p-4 rounded-lg mt-2 border-l-4 border-green-500">
                                ${company['Possible internship roles'] || 'Not specified'}
                            </div>
                        </div>
                        
                        <div>
                            <strong class="text-gray-900">OEP Batch:</strong>
                            <span class="text-gray-600">${company['OEP Batch'] || 'Not specified'}</span>
                        </div>
                        
                        <div>
                            <strong class="text-gray-900">Job Description:</strong>
                            <pre class="bg-gray-50 p-4 rounded-lg mt-2 border-l-4 border-green-500 whitespace-pre-wrap text-sm leading-relaxed">${company['Job Description'] || 'No job description available.'}</pre>
                        </div>
                    </div>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Close modal on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeFullCardModal();
                }
            });

            // Close modal with Escape key
            const handleEscape = function(e) {
                if (e.key === 'Escape') {
                    closeFullCardModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function closeFullCardModal() {
            const modal = document.getElementById('fullCardModal');
            if (modal) {
                modal.remove();
            }
        }

        function showCardInSidebar(companyName) {
            const sidebar = document.querySelector('.sidebar');
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('translate-x-full');
                document.querySelector('.overlay').classList.remove('hidden');
            }
            
            const companyIndex = companyData.findIndex(company => 
                company['Company Name'] === companyName
            );
            
            if (companyIndex !== -1) {
                const companyCard = document.querySelectorAll('.card')[companyIndex];
                if (companyCard) {
                    setTimeout(() => {
                        companyCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        companyCard.classList.add('ring-4', 'ring-green-300', 'ring-opacity-75');
                        
                        setTimeout(() => {
                            companyCard.classList.remove('ring-4', 'ring-green-300', 'ring-opacity-75');
                        }, 2000);
                    }, 300);
                }
            }
        }

        function initMap() {
            map = L.map('map', {
                center: [2.5, 108.0],
                zoom: 5,
                scrollWheelZoom: true
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        function addMarkers() {
            console.log(`üìç Adding ${filteredStartups.length} markers to map...`);
            
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (filteredStartups.length === 0) {
                console.warn('‚ö†Ô∏è No startups found to add markers!');
                return;
            }

            const validCoordinates = [];
            
            filteredStartups.forEach((startup, index) => {
                const lat = typeof startup.lat === 'number' ? startup.lat : null;
                const lng = typeof startup.lng === 'number' ? startup.lng : null;
                
                if (lat && lng && lat !== 0 && lng !== 0) {
                    try {
                        const marker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(createPopupContent(startup, index), {
                                maxWidth: 300,
                                maxHeight: 200,
                                autoPan: true,
                                keepInView: true,
                                closeButton: true,
                                autoClose: false,
                                closeOnEscapeKey: true,
                                className: 'custom-popup'
                            });
                        
                        markers.push(marker);
                        validCoordinates.push([lat, lng]);
                        
                        console.log(`‚úÖ Added marker for: ${startup.name || 'Startup ' + index} at ${lat}, ${lng}`);
                    } catch (error) {
                        console.error(`‚ùå Error adding marker:`, error);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Using backup location for: ${startup.name || 'Startup ' + index}`);
                    const backupLat = 3.1390;
                    const backupLng = 101.6869;
                    
                    try {
                        const marker = L.marker([backupLat, backupLng])
                            .addTo(map)
                            .bindPopup(createPopupContent(startup), {
                                maxWidth: 300,
                                maxHeight: 200,
                                autoPan: true,
                                keepInView: true,
                                closeButton: true,
                                autoClose: false,
                                closeOnEscapeKey: true,
                                className: 'custom-popup'
                            });
                        
                        markers.push(marker);
                        validCoordinates.push([backupLat, backupLng]);
                        
                        console.log(`‚úÖ Added backup marker for: ${startup.name || 'Startup ' + index}`);
                    } catch (error) {
                        console.error(`‚ùå Error adding backup marker:`, error);
                    }
                }
            });

            if (validCoordinates.length > 0) {
                setTimeout(() => {
                    map.fitBounds(validCoordinates, { padding: [30, 30], maxZoom: 8 });
                }, 100);
            } else {
                map.setView([3.1390, 101.6869], 6);
            }
            
            console.log(`‚úÖ Total markers added: ${markers.length}`);
        }

        function createPopupContent(startup, index) {
            const companyName = startup.name || startup['Company Name'];
            const email = startup.email || startup['Email'];
            const website = startup.website || startup['Website'];
            const phone = startup.contact || startup['Contact Number'];
            const roles = startup.role || startup['Possible internship roles'];
            
            return `
                <div class="p-3 max-w-sm">
                    <h3 class="text-base font-bold text-gray-800 mb-2">${companyName}</h3>
                    
                    <div class="space-y-1 text-xs">
                        ${roles ? `<div><strong>Roles:</strong> ${roles.length > 50 ? roles.substring(0, 50) + '...' : roles}</div>` : ''}
                        ${email ? `<div><strong>Email:</strong> <a href="mailto:${email}" class="text-blue-600">${email}</a></div>` : ''}
                        ${phone ? `<div><strong>Phone:</strong> <a href="tel:${phone}" class="text-blue-600">${phone}</a></div>` : ''}
                        ${website ? `<div><strong>Website:</strong> <a href="${website}" target="_blank" class="text-blue-600">Visit</a></div>` : ''}
                    </div>
                    
                    <button onclick="showCardInSidebar('${companyName}')" 
                            class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors">
                        View Full Details
                    </button>
                </div>
            `;
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');
            const isOpen = !sidebar.classList.contains('translate-x-full');

            if (isOpen) {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            } else {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }
        }

        function filterCompaniesByName() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const searchResultsInfo = document.getElementById('search-results-info');
            
            if (!searchTerm) {
                displayAPIDataInSidebar(allStartups);
                searchResultsInfo.classList.add('hidden');
                return;
            }

            const filteredCompanies = allStartups.filter(company => {
                const companyName = company['Company Name'] || '';
                return companyName.toLowerCase().includes(searchTerm);
            });

            displayAPIDataInSidebar(filteredCompanies);

            if (filteredCompanies.length === 0) {
                const container = document.getElementById('api-startup-list');
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10l.001-.003M15 10l.001-.003M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <p class="text-gray-600 font-medium">No companies found with that name.</p>
                        <p class="text-sm text-gray-500 mt-2">Try searching for a full or partial company name.</p>
                    </div>
                `;
                searchResultsInfo.textContent = `No companies found`;
            } 
            
            searchResultsInfo.classList.remove('hidden');
        }

        function getFullStartupData() {
            return [
                {
                    name: "GreenTech Solutions",
                    country: "Singapore",
                    lat: 1.3521,
                    lng: 103.8198,
                    category: "Clean Technology",
                    description: "Innovative solar energy solutions for urban environments",
                    image: "https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?w=150&h=150&fit=crop"
                }
            ];
        }

        // Handle escape key for search and sidebar
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const sidebar = document.querySelector('.sidebar');
                if (!sidebar.classList.contains('translate-x-full')) {
                    toggleSidebar();
                }
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadStartups().then(() => {
                // All initialization is done in loadStartups
            });
        });
    </script>
</body>
</html>